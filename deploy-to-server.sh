#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ .env
if [ ! -f .env ]; then
  echo "–§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –∏ —É–∫–∞–∂–∏—Ç–µ –≤ –Ω–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ SSH_USER, SSH_HOST –∏ SSH_PROJECT_PATH."
  exit 1
fi

source .env

# –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ –ø–µ—Ä–µ–¥–∞–µ–º –∞—Ä—Ö–∏–≤ —á–µ—Ä–µ–∑ ssh, –∑–∞—Ç–µ–º —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
# –ö–∞–∫ —è –ø–æ–Ω—è–ª –ø–æ—Å–ª–µ –∫—É—á–∏ –ø–æ–ø—ã—Ç–æ–∫ tar –∏ zip —É—Ç–∏–ª–∏—Ç—ã –æ—á–µ–Ω—å –æ—Ç–≤—Ä–∞—Ç–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç —Å–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫.
# –ï—Å–ª–∏ —è –Ω–∞–ø—Ä–∏–º–µ—Ä –ø–∏—à—É --exclude='./static', —Ç–æ –Ω–µ –∫–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞ static —É–±–µ—Ä–µ—Ç—Å—è, –∞ –≤—Å–µ –ø–∞–ø–∫–∏ static,
# –∞ –µ—Å–ª–∏ —è –±—É–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π –ø—É—Ç—å --exclude="$projDir/static" —Ç–æ –≤–æ–æ–±—â–µ –Ω–µ –∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è –ø–∞–ø–∫–∞) ü´†
tar cz --no-xattrs --no-mac-metadata \
  --exclude='.git' --exclude='.vscode' --exclude='migrations' \
  --exclude='static' --exclude='__pycache__' --exclude='media' . | \
sshpass -p "$SSH_PASSWORD" ssh "$SSH_USER"@"$SSH_HOST" \
  "mkdir -p $SSH_PROJECT_PATH && tar xz -C $SSH_PROJECT_PATH"

# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –≤ –æ–¥–Ω–æ–º ssh-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
sshpass -p "$SSH_PASSWORD" ssh "$SSH_USER"@"$SSH_HOST" "
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Docker –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
  which docker > /dev/null 2>&1
  DOCKER_EXISTS=$?

  if [ \$DOCKER_EXISTS -eq 0 ]; then
    echo 'Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –í—ã–ø–æ–ª–Ω—è–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–º–∞–Ω–¥—ã.'

    cd $SSH_PROJECT_PATH && docker compose -f docker-compose-server.yml up --build -d --force-recreate
  else
    echo 'Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.'
  fi
"
exit 0